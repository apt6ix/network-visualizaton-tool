<!DOCTYPE html>
<html lang="en">
<head>
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
	
	<style>
	    table, th, td { border:1px solid #000; padding:5px; }
	    #tooltip {
	        display:none;
	        position:fixed;
	        width:200px;
	        height:100px;
        }
        #chart { float: left; }
        #detail { float: right; }
	</style>
</head>
<body>
    <div id="chart">
        <select name="source" id="source">
            <option value=""> -- source -- </option>
        </select>
        <br />
	</div>
	
	<div id="detail"></div>
	
	<script>
	
	function loadDetails(proto, src) {
	    $.getJSON("/service/protocol/details/" + proto + "/" + src, function(data) {
	        var table = "";
	        var headers = "<tr><th>sport</th><th>destination</th><th>dport</th></tr>";
	        $.each(data, function(i, value) {
	            table += "<tr><td>" + value[1] 
	                + "</td><td>" + value[2] + "</td><td>" + value[3] + "</td></tr>";
	        }); 
	        $("#detail").html("<table>" + headers + table + "</table>");
	    });   
	}
	
	var r = 200;
	
	var color = d3.scale.category10();
	
	var canvas = d3.select("#chart").append("svg")
	    .attr("width", 400)
	    .attr("height", 400);
	
	function load(data) {    
	    var group = canvas.append("g")
	        .attr("transform", "translate(200, 200)");
	        
        var arc = d3.svg.arc()
            .innerRadius(0)
            .outerRadius(r);
            
        var pie = d3.layout.pie()
            .value(function(d) { return d.value; });
            
        var arcs = group.selectAll(".arc")
            .data(pie(data))
            .enter()
            .append("g")
            .attr("class", "arc")
            .on("click", function(d, i) { loadDetails(data[i].proto, $("#source").val()) } );
            //.on("mouseover", function(d) { 
            //    $("#tooltip").html(d.data.value).show();
            //})
            //.on("mousemove", function(d) {
            //    $("#tooltip").css("left", d3.mouse(this)[0]+200)
            //                 .css("top", d3.mouse(this)[1]+200)
            //})
            //.on("mouseout", function(d) {
            //    $("#tooltip").html("").hide();
            //})
            
        arcs.append("path")
            .attr("d", arc)
            .attr("fill", function(d, i) { return color(i) } );
            
        arcs.append("text")
            .attr("transform", function(d) { 
                return "translate(" + arc.centroid(d) + ")"; })
            .attr("text-anchor", "middle")
            .attr("font-size", "1.0em")
            .attr("fill", "white")
            .text(function(d, i) { return data[i].proto + " (" + data[i].value + ")"; } );
    }
	
    $.getJSON("/service/protocols", function(data) {    
        for (var key in data) {
            if (data.hasOwnProperty(key)) {
                $("#source").append("<option value='" + key + "'>" + key + "</option>");
            }
        }
        
        $("#source").change(function() {
            load(data[$(this).val()]);
        });
            
	});
	
	
	
	</script>
</body>
</html>
